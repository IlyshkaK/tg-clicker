<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
  <title>TG Clicker+</title>
  <style>
    :root { color-scheme: dark; }
    html,body{margin:0;height:100%;background:#0f0f12;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:520px;margin:0 auto;padding:16px 14px 110px}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:14px 14px;box-shadow:0 18px 60px rgba(0,0,0,.35)}
    .row{display:flex;gap:12px;align-items:center}
    .space{height:12px}
    .big{font-size:28px;font-weight:800;letter-spacing:.2px}
    .muted{opacity:.75}
    .coinBtn{
      width:200px;height:200px;margin:14px auto 0;
      border-radius:24px;border:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      display:flex;align-items:center;justify-content:center;
      user-select:none; -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .coinImg{width:110px;height:110px;image-rendering:pixelated;filter: drop-shadow(0 14px 18px rgba(0,0,0,.35))}
    .coinBtn:active{transform: translateY(1px) scale(.99)}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.2);font-size:13px;white-space:nowrap}
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    .shopItem{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .shopItem b{font-size:15px}
    .btn{
      padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);color:#fff;font-weight:700;cursor:pointer;
      user-select:none; -webkit-tap-highlight-color: transparent;
    }
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .footer{
      position:fixed;left:0;right:0;bottom:0;padding:12px 14px;
      background:rgba(15,15,18,.82);backdrop-filter: blur(10px);border-top:1px solid rgba(255,255,255,.08)
    }
    .footerInner{max-width:520px;margin:0 auto;display:flex;gap:10px;justify-content:space-between;align-items:center}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:90px;background:rgba(0,0,0,.65);
      border:1px solid rgba(255,255,255,.10);padding:10px 12px;border-radius:14px;font-size:13px;opacity:0;transition:opacity .18s}
    .toast.show{opacity:1}
    .split{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:520px){ .split{grid-template-columns:1fr 1fr;} }
    .leader{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:13px; line-height:1.45}
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
<div class="wrap">

  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div style="min-width:0">
        <div class="muted" id="hello">–ü—Ä–∏–≤–µ—Ç!</div>
        <div class="big" id="coins">0</div>
        <div class="muted" id="rate">+0/—Å–µ–∫</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
        <div class="pill" id="power">–°–∏–ª–∞ –∫–ª–∏–∫–∞: 1</div>
        <div class="pill" id="autos">–ê–≤—Ç–æ: 0</div>
        <div class="pill" id="mult">–ú–Ω–æ–∂–∏—Ç–µ–ª—å: x1</div>
        <div class="pill" id="prest">–ü—Ä–µ—Å—Ç–∏–∂: 0 (+0%)</div>
      </div>
    </div>

    <div class="coinBtn" id="tap">
      <img class="coinImg" src="/assets/coin.png" alt="coin"/>
    </div>
    <div class="space"></div>
    <div class="muted" style="text-align:center">–¢–∞–ø–∞–π –º–æ–Ω–µ—Ç—É. –ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>
  </div>

  <div class="space"></div>

  <div class="split">
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div>
          <b>–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞</b>
          <div class="muted" style="font-size:13px;margin-top:4px" id="dailyInfo">‚Äî</div>
        </div>
        <button class="btn" id="btnClaim">–ó–∞–±—Ä–∞—Ç—å</button>
      </div>
      <div class="space"></div>
      <div class="muted" style="font-size:13px">
        –ß–µ–º –±–æ–ª—å—à–µ —Å—Ç—Ä–∏–∫, —Ç–µ–º –±–æ–ª—å—à–µ –Ω–∞–≥—Ä–∞–¥–∞.
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div>
          <b>–ü—Ä–µ—Å—Ç–∏–∂</b>
          <div class="muted" style="font-size:13px;margin-top:4px" id="prestInfo">‚Äî</div>
        </div>
        <button class="btn" id="btnPrestige">–°–¥–µ–ª–∞—Ç—å –ø—Ä–µ—Å—Ç–∏–∂</button>
      </div>
      <div class="space"></div>
      <div class="muted" style="font-size:13px">
        –ü—Ä–µ—Å—Ç–∏–∂ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∞–ø–≥—Ä–µ–π–¥—ã, –Ω–æ –¥–∞—ë—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π –±–æ–Ω—É—Å –∫ –¥–æ—Ö–æ–¥—É.
      </div>
    </div>
  </div>

  <div class="space"></div>

  <div class="card">
    <div class="row" style="justify-content:space-between">
      <b>–ú–∞–≥–∞–∑–∏–Ω</b>
      <span class="muted" style="font-size:13px">–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ</span>
    </div>
    <div class="space"></div>
    <div class="grid" id="shop"></div>
  </div>

  <div class="space"></div>

  <div class="split">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</b>
</div>
      <div class="space"></div>
      <div class="muted" id="stats">‚Äî</div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <b>–õ–∏–¥–µ—Ä–±–æ—Ä–¥</b>
        <button class="btn" id="btnRefresh">–û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
      <div class="space"></div>
      <div class="muted leader" id="lb">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
    </div>
  </div>
</div>
</div>

<div class="toast" id="toast">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚úÖ</div>

<script>
(() => {
  const tg = window.Telegram?.WebApp;
  if (tg) { tg.ready(); tg.expand(); }

  const STORE_KEY = "tg_clicker_plus_v1";

  const elCoins = document.getElementById("coins");
  const elRate  = document.getElementById("rate");
  const elPower = document.getElementById("power");
  const elAutos = document.getElementById("autos");
  const elMult  = document.getElementById("mult");
  const elPrest = document.getElementById("prest");
  const elHello = document.getElementById("hello");
  const elShop  = document.getElementById("shop");
  const elStats = document.getElementById("stats");
  const elToast = document.getElementById("toast");
const elDailyInfo = document.getElementById("dailyInfo");
  const btnClaim = document.getElementById("btnClaim");

  const elPrestInfo = document.getElementById("prestInfo");
  const btnPrestige = document.getElementById("btnPrestige");
const btnRefresh = document.getElementById("btnRefresh");

  const tap = document.getElementById("tap");

  const user = tg?.initDataUnsafe?.user;
  const userId = user?.id ? String(user.id) : "local";
  const userName = user?.username ? "@"+user.username : (user?.first_name || "–ò–≥—Ä–æ–∫");
  elHello.textContent = `–ø—Ä–∏–≤–µ—Ç ${userName}`;

  const initData = tg?.initData || ""; // will be verified server-side if enabled

  function now(){ return Date.now(); }
  function clampInt(n, min, max){ n=Math.floor(Number(n)); if(!Number.isFinite(n)) n=min; return Math.max(min, Math.min(max, n)); }

  const defaultState = () => ({
    userId,
    coins: 0,
    clickPower: 1,
    autos: 0,
    mult: 1,
    prestige: 0,        // prestige level
    dailyStreak: 0,
    lastDailyDay: 0,    // day number (UTC) when claimed
    totalClicks: 0,
    totalEarned: 0,
    lastTs: now()
  });

  function loadLocal(){
    try {
      const s = JSON.parse(localStorage.getItem(STORE_KEY) || "null");
      if (!s) return defaultState();
      return { ...defaultState(), ...s, userId };
    } catch { return defaultState(); }
  }
  function saveLocal(state){
    localStorage.setItem(STORE_KEY, JSON.stringify(state));
  }
  let state = loadLocal();

// --- Sanitize state (fix old/broken saves) ---
function asNum(x, def=0){ const n = Number(x); return Number.isFinite(n) ? n : def; }
function sanitizeState(s){
  s.coins = Math.max(0, Math.floor(asNum(s.coins, 0)));
  s.clickPower = Math.max(1, Math.floor(asNum(s.clickPower, 1)));
  s.autos = Math.max(0, Math.floor(asNum(s.autos, 0)));
  s.mult = Math.max(1, Math.floor(asNum(s.mult, 1)));        // IMPORTANT: never 0
  s.prestige = Math.max(0, Math.floor(asNum(s.prestige, 0)));
  s.dailyStreak = Math.max(0, Math.floor(asNum(s.dailyStreak, 0)));
  s.lastDailyDay = Math.max(0, Math.floor(asNum(s.lastDailyDay, 0)));
  s.totalClicks = Math.max(0, Math.floor(asNum(s.totalClicks, 0)));
  s.totalEarned = Math.max(0, Math.floor(asNum(s.totalEarned, 0)));
  s.lastTs = Math.max(0, Math.floor(asNum(s.lastTs, now())));
  return s;
}
state = sanitizeState(state);

  

  // Passive income tick
  setInterval(() => {
    if (document.hidden) return;
    applyOffline();
    const add = Math.floor(getRatePerSec());
    if (add > 0) {
      state.coins += add;
      state.totalEarned += add;
      state.lastTs = now();
      saveLocal(state);
      render();
      // autosave softly
      scheduleSave("tick");
    }
  }, 1000);

  // Hard autosave every 10s
  setInterval(() => {
    applyOffline();
    saveLocal(state);
    quickSave("periodic");
  }, 10000);

  // Save on hide/close
  document.addEventListener("visibilitychange", () => {
    if (document.hidden) {
      applyOffline();
      saveLocal(state);
      quickSave("hide");
    }
  });
  window.addEventListener("beforeunload", () => {
    applyOffline();
    state = sanitizeState(state);
    saveLocal(state);
  });

  // Leaderboard UI
  async function refreshLeaderboard(){
    const lbEl = document.getElementById("lb");
    if (!lbEl) return;
    lbEl.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶";
    try {
      const res = await apiLbGet();
      if (!res?.ok) throw new Error("bad");
      const items = res.items || [];
      if (!items.length) {
        document.getElementById("lb").textContent = "–ü–æ–∫–∞ –ø—É—Å—Ç–æ üò∂";
        return;
      }
      const lines = items.map((it, i) => `${String(i+1).padStart(2," ")}  ${String(it.name||"Player").slice(0,16).padEnd(16," ")}  ${it.score}`);
      document.getElementById("lb").textContent = lines.join("\n");
    } catch {
      document.getElementById("lb").textContent = "–õ–∏–¥–µ—Ä–±–æ—Ä–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω";
    }
  }
  btnRefresh.addEventListener("click", refreshLeaderboard);

  // Start
  applyOffline();
  render();
  initialSync();
})();
</script>
</body>
</html>
