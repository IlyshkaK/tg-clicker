<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
  <title>TG Clicker+</title>
  <style>
    :root { color-scheme: dark; }
    html,body{margin:0;height:100%;background:#0f0f12;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:520px;margin:0 auto;padding:16px 14px 24px}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:14px 14px;box-shadow:0 18px 60px rgba(0,0,0,.35)}
    .row{display:flex;gap:12px;align-items:center}
    .space{height:12px}
    .big{font-size:28px;font-weight:800;letter-spacing:.2px}
    .muted{opacity:.75}
    .coinBtn{
      width:200px;height:200px;margin:14px auto 0;
      border-radius:24px;border:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      display:flex;align-items:center;justify-content:center;
      user-select:none; -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .coinImg{width:110px;height:110px;image-rendering:pixelated;filter: drop-shadow(0 14px 18px rgba(0,0,0,.35))}
    .coinBtn:active{transform: translateY(1px) scale(.99)}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.2);font-size:13px;white-space:nowrap}
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    .shopItem{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .shopItem b{font-size:15px}
    .btn{
      padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);color:#fff;font-weight:700;cursor:pointer;
      user-select:none; -webkit-tap-highlight-color: transparent;
    }
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .split{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:520px){ .split{grid-template-columns:1fr 1fr;} }
    .leader{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:13px; line-height:1.45; white-space:pre}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:14px;background:rgba(0,0,0,.65);
      border:1px solid rgba(255,255,255,.10);padding:10px 12px;border-radius:14px;font-size:13px;opacity:0;transition:opacity .18s}
    .toast.show{opacity:1}
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
<div class="wrap">

  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div style="min-width:0">
        <div class="muted" id="hello">Привет!</div>
        <div class="big" id="coins">0</div>
        <div class="muted" id="rate">+0/сек</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
        <div class="pill" id="power">Сила клика: 1</div>
        <div class="pill" id="autos">Авто: 0</div>
        <div class="pill" id="mult">Множитель: x1</div>
        <div class="pill" id="prest">Престиж: 0 (+0%)</div>
      </div>
    </div>

    <div class="coinBtn" id="tap">
      <img class="coinImg" src="/assets/coin.png" alt="coin"/>
    </div>
    <div class="space"></div>
    <div class="muted" style="text-align:center">Тапай монету. Прогресс сохраняется автоматически.</div>
  </div>

  <div class="space"></div>

  <div class="split">
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div>
          <b>Ежедневная награда</b>
          <div class="muted" style="font-size:13px;margin-top:4px" id="dailyInfo">—</div>
        </div>
        <button class="btn" id="btnClaim">Забрать</button>
      </div>
      <div class="space"></div>
      <div class="muted" style="font-size:13px">Чем больше стрик, тем больше награда.</div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div>
          <b>Престиж</b>
          <div class="muted" style="font-size:13px;margin-top:4px" id="prestInfo">—</div>
        </div>
        <button class="btn" id="btnPrestige">Сделать престиж</button>
      </div>
      <div class="space"></div>
      <div class="muted" style="font-size:13px">Престиж сбрасывает апгрейды, но даёт постоянный бонус к доходу.</div>
    </div>
  </div>

  <div class="space"></div>

  <div class="card">
    <div class="row" style="justify-content:space-between">
      <b>Магазин</b>
      <span class="muted" style="font-size:13px">Автосохранение</span>
    </div>
    <div class="space"></div>
    <div class="grid" id="shop"></div>
  </div>

  <div class="space"></div>

  <div class="split">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <b>Статистика</b>
</div>
      <div class="space"></div>
      <div class="muted" id="stats">—</div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <b>Лидерборд</b>
        <button class="btn" id="btnRefresh">Обновить</button>
      </div>
      <div class="space"></div>
      <div class="muted leader" id="lb">Загрузка…</div>
    </div>
  </div>

</div>

<div class="toast" id="toast">Сохранено ✅</div>

<script>
(() => {
  const tg = window.Telegram?.WebApp;
  if (tg) { tg.ready(); tg.expand(); }

  const STORE_KEY = "tg_clicker_plus_clean_v1";

  const elCoins = document.getElementById("coins");
  const elRate  = document.getElementById("rate");
  const elPower = document.getElementById("power");
  const elAutos = document.getElementById("autos");
  const elMult  = document.getElementById("mult");
  const elPrest = document.getElementById("prest");
  const elHello = document.getElementById("hello");
  const elShop  = document.getElementById("shop");
  const elStats = document.getElementById("stats");
  const elToast = document.getElementById("toast");
const elDailyInfo = document.getElementById("dailyInfo");
  const btnClaim = document.getElementById("btnClaim");

  const elPrestInfo = document.getElementById("prestInfo");
  const btnPrestige = document.getElementById("btnPrestige");
const tap = document.getElementById("tap");

  const initData = tg?.initData || "";

// Robust user extraction: initDataUnsafe OR parse initData param "user"
function getTgUser(){
  const u = tg?.initDataUnsafe?.user;
  if (u && (u.username || u.first_name)) return u;
  try {
    const params = new URLSearchParams(initData);
    const userStr = params.get("user");
    if (userStr) return JSON.parse(userStr);
  } catch {}
  return null;
}
const user = getTgUser();
const userId = user?.id ? String(user.id) : "local";
const userName = (user?.first_name || "Игрок");
elHello.textContent = `Привет, ${userName}`;

  const now = () => Date.now();
  const dayUTC = (ts) => Math.floor((ts || now()) / 86400000);
  const asNum = (x, d=0) => (Number.isFinite(Number(x)) ? Number(x) : d);

  const defaultState = () => ({
    userId,
    coins: 0,
    clickPower: 1,
    autos: 0,
    mult: 1,
    prestige: 0,
    dailyStreak: 0,
    lastDailyDay: 0,
    totalClicks: 0,
    totalEarned: 0,
    lastTs: now(),
    ver: 2,
    unit: 10
  });

  const loadLocal = () => {
    try {
      const s = JSON.parse(localStorage.getItem(STORE_KEY) || "null");
      if (!s) return defaultState();
      return { ...defaultState(), ...s, userId };
    } catch { return defaultState(); }
  };

  const saveLocal = (s) => localStorage.setItem(STORE_KEY, JSON.stringify(s));

  const sanitizeState = (s) => {
    // ver/unit migration: old saves were in whole coins, now we store tenths (unit=10)
    const ver = Math.floor(asNum(s.ver, 1));
    const unit = Math.floor(asNum(s.unit, 1));
    s.coins = Math.max(0, Math.floor(asNum(s.coins, 0)));
    if (ver < 2 || unit !== 10) {
      // convert whole coins -> tenths
      s.coins = s.coins * 10;
      s.unit = 10;
      s.ver = 2;
    } else {
      s.unit = 10;
      s.ver = 2;
    }
    s.clickPower = Math.max(1, Math.floor(asNum(s.clickPower, 1)));
    s.autos = Math.max(0, Math.floor(asNum(s.autos, 0)));
    s.mult = Math.max(1, Math.floor(asNum(s.mult, 1)));
    s.prestige = Math.max(0, Math.floor(asNum(s.prestige, 0)));
    s.dailyStreak = Math.max(0, Math.floor(asNum(s.dailyStreak, 0)));
    s.lastDailyDay = Math.max(0, Math.floor(asNum(s.lastDailyDay, 0)));
    s.totalClicks = Math.max(0, Math.floor(asNum(s.totalClicks, 0)));
    s.totalEarned = Math.max(0, Math.floor(asNum(s.totalEarned, 0)));
    s.lastTs = Math.max(0, Math.floor(asNum(s.lastTs, now())));
    return s;
  };

  let state = sanitizeState(loadLocal());
  saveLocal(state);

  const prestigeBonus = () => 1 + state.prestige * 0.05;
  const ratePerSec = () => Math.floor(state.autos * state.mult * prestigeBonus() * 10);
  const clickGain = () => Math.floor(state.clickPower * state.mult * prestigeBonus() * 5); // 0.5 coin base -> 5 tenths

  const fmtMoney = (coins10) => {
    const v = (Number(coins10)||0) / 10;
    // show one decimal for < 1000, otherwise compact
    if (v < 1000) return v.toFixed(1).replace(/\.0$/,"");
    const n = Math.floor(v);
    if (n < 1e6) return (n/1e3).toFixed(1).replace(/\.0$/,"")+"K";
    if (n < 1e9) return (n/1e6).toFixed(1).replace(/\.0$/,"")+"M";
    if (n < 1e12) return (n/1e9).toFixed(1).replace(/\.0$/,"")+"B";
    return (n/1e12).toFixed(1).replace(/\.0$/,"")+"T";
  };

  const fmtInt = (n) => {
    n = Math.floor(Number(n)||0);
    if (n < 1000) return String(n);
    if (n < 1e6) return (n/1e3).toFixed(1).replace(/\.0$/,"")+"K";
    if (n < 1e9) return (n/1e6).toFixed(1).replace(/\.0$/,"")+"M";
    if (n < 1e12) return (n/1e9).toFixed(1).replace(/\.0$/,"")+"B";
    return (n/1e12).toFixed(1).replace(/\.0$/,"")+"T";
  };

  const applyOffline = () => {
    const dt = Math.max(0, (now() - (state.lastTs || now())) / 1000);
    const earned = Math.floor(ratePerSec() * dt);
    if (earned > 0) {
      state.coins += earned;
      state.totalEarned += earned;
    }
    state.lastTs = now();
  };

  const shopItems = [
    { id:"power", name:"Усилить клик", desc:"+1 к силе клика", price: () => (100 + (state.clickPower-1) * 180) * 10 },
    { id:"auto",  name:"Авто-майнер",  desc:"+1 монета/сек",  price: () => Math.floor(1200 * Math.pow(1.35, state.autos)) * 10 },
    { id:"mult",  name:"Множитель",    desc:"x2 к доходу",     price: () => (25000 * Math.pow(2, Math.max(0, Math.log2(state.mult)))) * 10 },
  ];

  const showToast = (text) => {
    elToast.textContent = text;
    elToast.classList.add("show");
    clearTimeout(showToast._t);
    showToast._t = setTimeout(() => elToast.classList.remove("show"), 900);
  };

  const renderShop = () => {
    elShop.innerHTML = "";
    for (const it of shopItems) {
      const price = Math.floor(it.price());
      const can = state.coins >= price;
      const row = document.createElement("div");
      row.className = "shopItem";
      row.innerHTML = `
        <div style="min-width:0">
          <b>${it.name}</b>
          <div class="muted" style="font-size:13px">${it.desc}</div>
          <div class="muted" style="font-size:13px">Цена: ${fmtMoney(price)}</div>
        </div>
        <button class="btn" ${can ? "" : "disabled"}>Купить</button>`;
      row.querySelector("button").addEventListener("click", () => buy(it.id, price));
      elShop.appendChild(row);
    }
  };

  const renderDaily = () => {
    const today = dayUTC(now());
    const can = state.lastDailyDay !== today;
    const missed = (state.lastDailyDay && today - state.lastDailyDay > 1);
    const nextStreak = can ? (missed ? 1 : Math.max(1, state.dailyStreak + 1)) : state.dailyStreak;
    const amount = Math.floor(10 + Math.min(20, nextStreak) * 5) * 10;
    btnClaim.disabled = !can;
    elDailyInfo.textContent = can
      ? `Доступно: +${fmtMoney(amount)} • Стрик будет: ${nextStreak}${missed ? " (был пропуск)" : ""}`
      : `Уже забрано сегодня • Стрик: ${state.dailyStreak}`;
  };

  const prestigeCost = () => Math.floor(150000 * Math.pow(2.55, state.prestige)) * 10;
  const renderPrestige = () => {
    const cost = prestigeCost();
    btnPrestige.disabled = state.coins < cost;
    elPrestInfo.textContent = `Стоимость: ${fmtMoney(cost)} • Бонус: +${Math.floor(state.prestige*5)}% → +${Math.floor((state.prestige+1)*5)}%`;
  };

  const render = () => {
    elCoins.textContent = fmtMoney(state.coins);
    elRate.textContent = `+${fmtMoney(ratePerSec())}/сек`;
    elPower.textContent = `Сила клика: ${state.clickPower}`;
    elAutos.textContent = `Авто: ${state.autos}`;
    elMult.textContent = `Множитель: x${state.mult}`;
    elPrest.textContent = `Престиж: ${state.prestige} (+${Math.floor(state.prestige*5)}%)`;

    elStats.textContent = `Кликов: ${fmtInt(state.totalClicks)} • Всего заработано: ${fmtMoney(state.totalEarned)}`;
    renderShop();
    renderDaily();
    renderPrestige();
  };

  const buy = (id, price) => {
    if (state.coins < price) return;
    state.coins -= price;
    if (id === "power") state.clickPower += 1;
    if (id === "auto") state.autos += 1;
    if (id === "mult") state.mult *= 2;
    saveLocal(state);
    render();
    scheduleSave("buy");
  };

  btnClaim.addEventListener("click", () => {
    applyOffline();
    const today = dayUTC(now());
    if (state.lastDailyDay === today) return;

    const missed = (state.lastDailyDay && today - state.lastDailyDay > 1);
    state.dailyStreak = missed ? 1 : Math.max(1, state.dailyStreak + 1);

    const amount = Math.floor(10 + Math.min(20, state.dailyStreak) * 5) * 10;
    state.coins += amount;
    state.totalEarned += amount;
    state.lastDailyDay = today;

    saveLocal(state);
    render();
    showToast(`Награда: +${fmtMoney(amount)} ✅`);
    scheduleSave("daily");
  });

  btnPrestige.addEventListener("click", () => {
    applyOffline();
    const cost = prestigeCost();
    if (state.coins < cost) return;
    if (!confirm(`Сделать престиж за ${fmtMoney(cost)}? Апгрейды сбросятся.`)) return;

    state.coins -= cost;
    state.prestige += 1;
    state.clickPower = 1;
    state.autos = 0;
    state.mult = 1;

    saveLocal(state);
    render();
    showToast("Престиж выполнен ⭐");
    scheduleSave("prestige");
  });

  const doTap = () => {
    applyOffline();
    const gain = clickGain();
    state.coins += gain;
    state.totalEarned += gain;
    state.totalClicks += 1;
    state.lastTs = now();
    saveLocal(state);
    render();
    scheduleSave("tap");
  };
  tap.addEventListener("pointerdown", (e) => { e.preventDefault(); doTap(); });

  // API
  const apiGetProgress = async () => {
    const r = await fetch(`/api/progress?userId=${encodeURIComponent(userId)}`);
    return await r.json();
  };
  const apiSetProgress = async () => {
    const payload = {
      userId,
      initData,
      state: {
        coins: Math.floor(state.coins),
        clickPower: state.clickPower,
        autos: state.autos,
        mult: state.mult,
        prestige: state.prestige,
        dailyStreak: state.dailyStreak,
        lastDailyDay: state.lastDailyDay,
        totalClicks: Math.floor(state.totalClicks),
        totalEarned: Math.floor(state.totalEarned),
        lastTs: state.lastTs
      }
    };
    const r = await fetch(`/api/progress`, { method:"POST", headers:{ "content-type":"application/json" }, body: JSON.stringify(payload) });
    return await r.json();
  };
    const r = await fetch(`/api/leaderboard`, { method:"POST", headers:{ "content-type":"application/json" }, body: JSON.stringify(payload) });
    return await r.json();
  };

  const mergeFromServer = (s) => {
    state.coins = Math.max(state.coins, Math.floor(asNum(s.coins, 0)));
    state.clickPower = Math.max(state.clickPower, Math.floor(asNum(s.clickPower, 1)));
    state.autos = Math.max(state.autos, Math.floor(asNum(s.autos, 0)));
    state.mult = Math.max(state.mult, Math.floor(asNum(s.mult, 1)));
    state.prestige = Math.max(state.prestige, Math.floor(asNum(s.prestige, 0)));
    state.dailyStreak = Math.max(state.dailyStreak, Math.floor(asNum(s.dailyStreak, 0)));
    state.lastDailyDay = Math.max(state.lastDailyDay, Math.floor(asNum(s.lastDailyDay, 0)));
    state.totalClicks = Math.max(state.totalClicks, Math.floor(asNum(s.totalClicks, 0)));
    state.totalEarned = Math.max(state.totalEarned, Math.floor(asNum(s.totalEarned, 0)));
    state.lastTs = now();
    sanitizeState(state);
    saveLocal(state);
  };

  let saving = false;
  let saveQueued = false;

  const quickSave = async (reason) => {
    if (saving) { saveQueued = true; return; }
    saving = true;
    try {
      applyOffline();
      saveLocal(state);
await apiSetProgress();
} catch {
} finally {
      saving = false;
      if (saveQueued) { saveQueued = false; quickSave("queued"); }
    }
  };

  let saveTimer = null;
  const scheduleSave = (reason) => {
    clearTimeout(saveTimer);
    saveTimer = setTimeout(() => {
      quickSave(reason || "debounced");
      }, 650);
  };

  const initialSync = async () => {
try {
      const res = await apiGetProgress();
      if (res?.ok && res?.state) mergeFromServer(res.state);
} catch {
}
    render();
  };

  setInterval(() => {
    if (document.hidden) return;
    applyOffline();
    const add = Math.floor(ratePerSec());
    if (add > 0) {
      state.coins += add;
      state.totalEarned += add;
      state.lastTs = now();
      saveLocal(state);
      render();
      scheduleSave("tick");
    }
  }, 1000);

  setInterval(() => quickSave("periodic"), 12000);

  document.addEventListener("visibilitychange", () => {
    if (document.hidden) quickSave("hide");
  });

  applyOffline();
  render();
  initialSync();
})();
</script>
</body>
</html>
