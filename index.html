<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
  <title>TG Clicker+</title>
  <style>
    :root { color-scheme: dark; }
    html,body{margin:0;height:100%;background:#0f0f12;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:520px;margin:0 auto;padding:16px 14px 110px}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:14px 14px;box-shadow:0 18px 60px rgba(0,0,0,.35)}
    .row{display:flex;gap:12px;align-items:center}
    .space{height:12px}
    .big{font-size:28px;font-weight:800;letter-spacing:.2px}
    .muted{opacity:.75}
    .coinBtn{
      width:200px;height:200px;margin:14px auto 0;
      border-radius:24px;border:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      display:flex;align-items:center;justify-content:center;
      user-select:none; -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .coinImg{width:110px;height:110px;image-rendering:pixelated;filter: drop-shadow(0 14px 18px rgba(0,0,0,.35))}
    .coinBtn:active{transform: translateY(1px) scale(.99)}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.2);font-size:13px;white-space:nowrap}
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    .shopItem{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .shopItem b{font-size:15px}
    .btn{
      padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);color:#fff;font-weight:700;cursor:pointer;
      user-select:none; -webkit-tap-highlight-color: transparent;
    }
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .footer{
      position:fixed;left:0;right:0;bottom:0;padding:12px 14px;
      background:rgba(15,15,18,.82);backdrop-filter: blur(10px);border-top:1px solid rgba(255,255,255,.08)
    }
    .footerInner{max-width:520px;margin:0 auto;display:flex;gap:10px;justify-content:space-between;align-items:center}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:90px;background:rgba(0,0,0,.65);
      border:1px solid rgba(255,255,255,.10);padding:10px 12px;border-radius:14px;font-size:13px;opacity:0;transition:opacity .18s}
    .toast.show{opacity:1}
    .split{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:520px){ .split{grid-template-columns:1fr 1fr;} }
    .leader{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:13px; line-height:1.45}
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
<div class="wrap">

  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div style="min-width:0">
        <div class="muted" id="hello">–ü—Ä–∏–≤–µ—Ç!</div>
        <div class="big" id="coins">0</div>
        <div class="muted" id="rate">+0/—Å–µ–∫</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
        <div class="pill" id="power">–°–∏–ª–∞ –∫–ª–∏–∫–∞: 1</div>
        <div class="pill" id="autos">–ê–≤—Ç–æ: 0</div>
        <div class="pill" id="mult">–ú–Ω–æ–∂–∏—Ç–µ–ª—å: x1</div>
        <div class="pill" id="prest">–ü—Ä–µ—Å—Ç–∏–∂: 0 (+0%)</div>
      </div>
    </div>

    <div class="coinBtn" id="tap">
      <img class="coinImg" src="/assets/coin.png" alt="coin"/>
    </div>
    <div class="space"></div>
    <div class="muted" style="text-align:center">–¢–∞–ø–∞–π –º–æ–Ω–µ—Ç—É. –ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>
  </div>

  <div class="space"></div>

  <div class="split">
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div>
          <b>–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞</b>
          <div class="muted" style="font-size:13px;margin-top:4px" id="dailyInfo">‚Äî</div>
        </div>
        <button class="btn" id="btnClaim">–ó–∞–±—Ä–∞—Ç—å</button>
      </div>
      <div class="space"></div>
      <div class="muted" style="font-size:13px">
        –ß–µ–º –±–æ–ª—å—à–µ —Å—Ç—Ä–∏–∫, —Ç–µ–º –±–æ–ª—å—à–µ –Ω–∞–≥—Ä–∞–¥–∞.
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div>
          <b>–ü—Ä–µ—Å—Ç–∏–∂</b>
          <div class="muted" style="font-size:13px;margin-top:4px" id="prestInfo">‚Äî</div>
        </div>
        <button class="btn" id="btnPrestige">–°–¥–µ–ª–∞—Ç—å –ø—Ä–µ—Å—Ç–∏–∂</button>
      </div>
      <div class="space"></div>
      <div class="muted" style="font-size:13px">
        –ü—Ä–µ—Å—Ç–∏–∂ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∞–ø–≥—Ä–µ–π–¥—ã, –Ω–æ –¥–∞—ë—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π –±–æ–Ω—É—Å –∫ –¥–æ—Ö–æ–¥—É.
      </div>
    </div>
  </div>

  <div class="space"></div>

  <div class="card">
    <div class="row" style="justify-content:space-between">
      <b>–ú–∞–≥–∞–∑–∏–Ω</b>
      <span class="muted" style="font-size:13px">–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ</span>
    </div>
    <div class="space"></div>
    <div class="grid" id="shop"></div>
  </div>

  <div class="space"></div>

  <div class="split">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</b>
</div>
      <div class="space"></div>
      <div class="muted" id="stats">‚Äî</div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <b>–õ–∏–¥–µ—Ä–±–æ—Ä–¥</b>
        <button class="btn" id="btnRefresh">–û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
      <div class="space"></div>
      <div class="muted leader" id="lb">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
    </div>
  </div>
</div>
</div>

<div class="toast" id="toast">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚úÖ</div>

<script>
(() => {
  const tg = window.Telegram?.WebApp;
  if (tg) { tg.ready(); tg.expand(); }

  const STORE_KEY = "tg_clicker_plus_v1";

  const elCoins = document.getElementById("coins");
  const elRate  = document.getElementById("rate");
  const elPower = document.getElementById("power");
  const elAutos = document.getElementById("autos");
  const elMult  = document.getElementById("mult");
  const elPrest = document.getElementById("prest");
  const elHello = document.getElementById("hello");
  const elShop  = document.getElementById("shop");
  const elStats = document.getElementById("stats");
  const elToast = document.getElementById("toast");
const elDailyInfo = document.getElementById("dailyInfo");
  const btnClaim = document.getElementById("btnClaim");

  const elPrestInfo = document.getElementById("prestInfo");
  const btnPrestige = document.getElementById("btnPrestige");
const btnRefresh = document.getElementById("btnRefresh");

  const tap = document.getElementById("tap");

  const user = tg?.initDataUnsafe?.user;
  const userId = user?.id ? String(user.id) : "local";
  const userName = user?.username ? "@"+user.username : (user?.first_name || "–ò–≥—Ä–æ–∫");
  elHello.textContent = `–ø—Ä–∏–≤–µ—Ç ${userName}`;

  const initData = tg?.initData || ""; // will be verified server-side if enabled

  function now(){ return Date.now(); }
  function clampInt(n, min, max){ n=Math.floor(Number(n)); if(!Number.isFinite(n)) n=min; return Math.max(min, Math.min(max, n)); }

  const defaultState = () => ({
    userId,
    coins: 0,
    clickPower: 1,
    autos: 0,
    mult: 1,
    prestige: 0,        // prestige level
    dailyStreak: 0,
    lastDailyDay: 0,    // day number (UTC) when claimed
    totalClicks: 0,
    totalEarned: 0,
    lastTs: now()
  });

  function loadLocal(){
    try {
      const s = JSON.parse(localStorage.getItem(STORE_KEY) || "null");
      if (!s) return defaultState();
      return { ...defaultState(), ...s, userId };
    } catch { return defaultState(); }
  }
  function saveLocal(state){
    localStorage.setItem(STORE_KEY, JSON.stringify(state));
  }
  let state = loadLocal();

  function prestigeBonus(){
    // +5% per prestige level
    return 1 + state.prestige * 0.05;
  }
  function getRatePerSec(){
    return state.autos * 1 * state.mult * prestigeBonus();
  }
  function clickGain(){
    return state.clickPower * state.mult * prestigeBonus();
  }

  function dayUTC(ts){
    return Math.floor((ts || now()) / 86400000); // days since epoch (UTC)
  }

  // Offline earnings
  function applyOffline(){
    const dt = Math.max(0, (now() - (state.lastTs || now())) / 1000);
    const earned = Math.floor(getRatePerSec() * dt);
    if (earned > 0) {
      state.coins += earned;
      state.totalEarned += earned;
    }
    state.lastTs = now();
  }

  function fmt(n){
    n = Math.floor(Number(n)||0);
    if (n < 1000) return String(n);
    if (n < 1e6) return (n/1e3).toFixed(1).replace(/\.0$/,"")+"K";
    if (n < 1e9) return (n/1e6).toFixed(1).replace(/\.0$/,"")+"M";
    if (n < 1e12) return (n/1e9).toFixed(1).replace(/\.0$/,"")+"B";
    return (n/1e12).toFixed(1).replace(/\.0$/,"")+"T";
  }

  const shopItems = [
    { id: "power", name: "–£—Å–∏–ª–∏—Ç—å –∫–ª–∏–∫", desc: "+1 –∫ —Å–∏–ª–µ –∫–ª–∏–∫–∞", price: () => 10 + (state.clickPower-1) * 15 },
    { id: "auto",  name: "–ê–≤—Ç–æ-–º–∞–π–Ω–µ—Ä",  desc: "+1 –º–æ–Ω–µ—Ç–∞/—Å–µ–∫",  price: () => 50 + state.autos * 60 },
    { id: "mult",  name: "–ú–Ω–æ–∂–∏—Ç–µ–ª—å",    desc: "x2 –∫ –¥–æ—Ö–æ–¥—É",     price: () => 250 * Math.pow(2, Math.max(0, Math.log2(state.mult))) }
  ];

  function render(){
    elCoins.textContent = fmt(state.coins);
    elRate.textContent = `+${fmt(getRatePerSec())}/—Å–µ–∫`;
    elPower.textContent = `–°–∏–ª–∞ –∫–ª–∏–∫–∞: ${state.clickPower}`;
    elAutos.textContent = `–ê–≤—Ç–æ: ${state.autos}`;
    elMult.textContent = `–ú–Ω–æ–∂–∏—Ç–µ–ª—å: x${state.mult}`;
    elPrest.textContent = `–ü—Ä–µ—Å—Ç–∏–∂: ${state.prestige} (+${Math.floor(state.prestige*5)}%)`;

    elStats.textContent = `–ö–ª–∏–∫–æ–≤: ${fmt(state.totalClicks)} ‚Ä¢ –í—Å–µ–≥–æ –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ: ${fmt(state.totalEarned)}`;

    renderShop();
    renderDaily();
    renderPrestige();
  }

  function renderShop(){
    elShop.innerHTML = "";
    for (const it of shopItems) {
      const price = Math.floor(it.price());
      const can = state.coins >= price;

      const row = document.createElement("div");
      row.className = "shopItem";
      row.innerHTML = `
        <div style="min-width:0">
          <b>${it.name}</b>
          <div class="muted" style="font-size:13px">${it.desc}</div>
          <div class="muted" style="font-size:13px">–¶–µ–Ω–∞: ${fmt(price)}</div>
        </div>
        <button class="btn" ${can ? "" : "disabled"}>–ö—É–ø–∏—Ç—å</button>
      `;
      row.querySelector("button").addEventListener("click", () => buy(it.id, price));
      elShop.appendChild(row);
    }
  }

  function buy(id, price){
    if (state.coins < price) return;
    state.coins -= price;
    if (id === "power") state.clickPower += 1;
    if (id === "auto") state.autos += 1;
    if (id === "mult") state.mult *= 2;
    saveLocal(state);
    render();
    scheduleSave("buy");
  }

  // Tap
  function doTap(){
    applyOffline();
    const gain = clickGain();
    state.coins += gain;
    state.totalEarned += gain;
    state.totalClicks += 1;
    state.lastTs = now();
    saveLocal(state);
    render();
    scheduleSave("tap");
  }
  tap.addEventListener("pointerdown", (e) => { e.preventDefault(); doTap(); });

  // Daily rewards
  function dailyCanClaim(){
    const today = dayUTC(now());
    return state.lastDailyDay !== today;
  }
  function dailyAmountFor(streak){
    // base 50, grows +20 per streak, capped gently
    return Math.floor(50 + Math.min(30, streak) * 20);
  }
  function renderDaily(){
    const today = dayUTC(now());
    const can = dailyCanClaim();
    let streak = state.dailyStreak;
    // if missed day => streak resets on claim logic, but show info:
    const missed = (state.lastDailyDay && today - state.lastDailyDay > 1);
    const nextStreak = can ? (missed ? 1 : Math.max(1, streak + 1)) : streak;
    const amount = dailyAmountFor(nextStreak);
    btnClaim.disabled = !can;
    elDailyInfo.textContent = can
      ? `–î–æ—Å—Ç—É–ø–Ω–æ: +${fmt(amount)} ‚Ä¢ –°–ª–µ–¥—É—é—â–∏–π —Å—Ç—Ä–∏–∫: ${nextStreak}${missed ? " (–ø—Ä–æ–ø—É—Å–∫ –±—ã–ª)" : ""}`
      : `–£–∂–µ –∑–∞–±—Ä–∞–Ω–æ —Å–µ–≥–æ–¥–Ω—è ‚Ä¢ –°—Ç—Ä–∏–∫: ${streak}`;
  }
  btnClaim.addEventListener("click", () => {
    applyOffline();
    const today = dayUTC(now());
    if (!dailyCanClaim()) return;

    const missed = (state.lastDailyDay && today - state.lastDailyDay > 1);
    state.dailyStreak = missed ? 1 : Math.max(1, state.dailyStreak + 1);

    const amount = dailyAmountFor(state.dailyStreak);
    state.coins += amount;
    state.totalEarned += amount;
    state.lastDailyDay = today;
    saveLocal(state);
    render();
    showToast(`–ù–∞–≥—Ä–∞–¥–∞: +${fmt(amount)} ‚úÖ`);
    scheduleSave("daily");
  });

  // Prestige
  function prestigeCost(){
    // cost in coins to prestige: grows fast
    // 5k, 20k, 60k, 150k, ...
    return Math.floor(5000 * Math.pow(2.0, state.prestige));
  }
  function canPrestige(){
    return state.coins >= prestigeCost();
  }
  function renderPrestige(){
    const cost = prestigeCost();
    btnPrestige.disabled = !canPrestige();
    elPrestInfo.textContent = `–°—Ç–æ–∏–º–æ—Å—Ç—å: ${fmt(cost)} ‚Ä¢ –ë–æ–Ω—É—Å —Å–µ–π—á–∞—Å: +${Math.floor(state.prestige*5)}% ‚Ä¢ –ü–æ—Å–ª–µ: +${Math.floor((state.prestige+1)*5)}%`;
  }
  btnPrestige.addEventListener("click", () => {
    applyOffline();
    const cost = prestigeCost();
    if (state.coins < cost) return;
    if (!confirm(`–°–¥–µ–ª–∞—Ç—å –ø—Ä–µ—Å—Ç–∏–∂ –∑–∞ ${fmt(cost)}? –ê–ø–≥—Ä–µ–π–¥—ã —Å–±—Ä–æ—Å—è—Ç—Å—è.`)) return;

    state.coins -= cost;
    state.prestige += 1;

    // reset upgrades, keep prestige + daily + totals
    state.clickPower = 1;
    state.autos = 0;
    state.mult = 1;

    saveLocal(state);
    render();
    showToast("–ü—Ä–µ—Å—Ç–∏–∂ –≤—ã–ø–æ–ª–Ω–µ–Ω ‚≠ê");
    scheduleSave("prestige");
  });

  // Toast
  let toastTimer = null;
  function showToast(text){
    elToast.textContent = text;
    elToast.classList.add("show");
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => elToast.classList.remove("show"), 900);
  }

  // ---------- Server sync & anti-cheat (initData verified on server) ----------
  async function apiGet(){
    const r = await fetch(`/api/progress?userId=${encodeURIComponent(userId)}`);
    return await r.json();
  }
  async function apiSet(payload){
    const r = await fetch(`/api/progress`, {
      method: "POST",
      headers: { "content-type":"application/json" },
      body: JSON.stringify(payload)
    });
    return await r.json();
  }

  async function apiSubmitScore(score){
    const r = await fetch(`/api/leaderboard`, {
      method: "POST",
      headers: { "content-type":"application/json" },
      body: JSON.stringify({ userId, name: userName, score, initData })
    });
    return await r.json();
  }

  async function apiLbGet(){
    const r = await fetch(`/api/leaderboard?limit=10`);
    return await r.json();
  }

  function mergeFromServer(s){
    // Merge: take maximums (simple & safe)
    state.coins = Math.max(state.coins, clampInt(s.coins, 0, 1e12));
    state.clickPower = Math.max(state.clickPower, clampInt(s.clickPower, 1, 1e6));
    state.autos = Math.max(state.autos, clampInt(s.autos, 0, 1e6));
    state.mult = Math.max(state.mult, clampInt(s.mult, 1, 1e9));
    state.prestige = Math.max(state.prestige, clampInt(s.prestige, 0, 1e6));
    state.dailyStreak = Math.max(state.dailyStreak, clampInt(s.dailyStreak, 0, 1e6));
    state.lastDailyDay = Math.max(state.lastDailyDay, clampInt(s.lastDailyDay, 0, 1e12));
    state.totalClicks = Math.max(state.totalClicks, clampInt(s.totalClicks, 0, 1e12));
    state.totalEarned = Math.max(state.totalEarned, clampInt(s.totalEarned, 0, 1e12));
    state.lastTs = now();
    saveLocal(state);
  }

  async function initialSync(){
try {
      const res = await apiGet();
      if (res?.ok && res?.state) mergeFromServer(res.state);
} catch {
}
    render();
    refreshLeaderboard();
  }

  let saving = false;
  let saveQueued = false;
  async function quickSave(reason){
    if (saving) { saveQueued = true; return; }
    saving = true;
    try {
      const payload = {
        userId,
        initData, // optional but enables verification if server configured
        state: {
          coins: Math.floor(state.coins),
          clickPower: state.clickPower,
          autos: state.autos,
          mult: state.mult,
          prestige: state.prestige,
          dailyStreak: state.dailyStreak,
          lastDailyDay: state.lastDailyDay,
          totalClicks: Math.floor(state.totalClicks),
          totalEarned: Math.floor(state.totalEarned),
          lastTs: state.lastTs
        }
      };
      await apiSet(payload);

      // Submit score: use totalEarned + prestige weight (simple)
      const score = Math.floor(state.totalEarned + state.prestige * 10000);
      await apiSubmitScore(score);
      await refreshLeaderboard();
    } catch {}
    saving = false;
    if (saveQueued) { saveQueued = false; quickSave("queued"); }
  }

  let saveTimer = null;
  function scheduleSave(reason){
    // debounce saves: batch frequent taps
    clearTimeout(saveTimer);
    saveTimer = setTimeout(() => {
      applyOffline();
      saveLocal(state);
      quickSave(reason || "debounced");
      showToast("–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ‚úÖ");
    }, 600);
  }
saveLocal(state);
    await quickSave("manual");
    showToast("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚úÖ");
  });
const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "clicker-save.json";
    a.click();
    URL.revokeObjectURL(a.href);
  });

  // Passive income tick
  setInterval(() => {
    if (document.hidden) return;
    applyOffline();
    const add = Math.floor(getRatePerSec());
    if (add > 0) {
      state.coins += add;
      state.totalEarned += add;
      state.lastTs = now();
      saveLocal(state);
      render();
      // autosave softly
      scheduleSave("tick");
    }
  }, 1000);

  // Hard autosave every 10s
  setInterval(() => {
    applyOffline();
    saveLocal(state);
    quickSave("periodic");
  }, 10000);

  // Save on hide/close
  document.addEventListener("visibilitychange", () => {
    if (document.hidden) {
      applyOffline();
      saveLocal(state);
      quickSave("hide");
    }
  });
  window.addEventListener("beforeunload", () => {
    applyOffline();
    saveLocal(state);
  });

  // Leaderboard UI
  async function refreshLeaderboard(){
    try {
      const res = await apiLbGet();
      if (!res?.ok) throw new Error("bad");
      const items = res.items || [];
      if (!items.length) {
        document.getElementById("lb").textContent = "–ü–æ–∫–∞ –ø—É—Å—Ç–æ üò∂";
        return;
      }
      const lines = items.map((it, i) => `${String(i+1).padStart(2," ")}  ${String(it.name||"Player").slice(0,16).padEnd(16," ")}  ${it.score}`);
      document.getElementById("lb").textContent = lines.join("\n");
    } catch {
      document.getElementById("lb").textContent = "–õ–∏–¥–µ—Ä–±–æ—Ä–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω";
    }
  }
  btnRefresh.addEventListener("click", refreshLeaderboard);

  // Start
  applyOffline();
  render();
  initialSync();
})();
</script>
</body>
</html>
